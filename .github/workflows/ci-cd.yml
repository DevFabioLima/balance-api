name: ci-cd

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/go-api

jobs:
  test-build-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        run: |
          docker build -t "$IMAGE_NAME:${{ steps.meta.outputs.image_tag }}" -t "$IMAGE_NAME:latest" .
          docker push "$IMAGE_NAME:${{ steps.meta.outputs.image_tag }}"
          docker push "$IMAGE_NAME:latest"

  deploy:
    runs-on: ubuntu-latest
    needs: test-build-push
    steps:
      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy container on EC2
        run: |
          IMAGE="$IMAGE_NAME:${{ needs.test-build-push.outputs.image_tag }}"
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
          "docker pull $IMAGE && \
          docker rm -f eth-balance-api || true && \
          docker run -d --name eth-balance-api --restart unless-stopped \
          -p 8080:8080 \
          -e PORT=8080 \
          -e INFURA_URL='${{ secrets.INFURA_URL }}' \
          $IMAGE"
